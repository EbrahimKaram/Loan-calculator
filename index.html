<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZLLJPXEX6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FZLLJPXEX6');
    </script>
    <meta charset="UTF-8">
    <title>Loan Payoff Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta property="og:title" content="Loan Payoff Chart" />
    <meta property="og:description" content="Visualize how your loan payments affect your balances over time. Add as many loans as you like." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://www.ebrahimkaram.com/Loan-calculator/images/LoanCalculator.gif">
    <meta property="og:image:type" content="image/gif">
    <meta property="og:image:width" content="600">
    <meta property="og:image:height" content="400">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <style>
        .bmc-float {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 9999;
            pointer-events: auto;
        }

        @media (max-width: 600px) {
            .bmc-float {
                right: 8px;
                bottom: 8px;
            }
        }

        body {
            background: #f7f8fa;
            padding: 10px;
        }

        .loan-control {
            background: #fff;
            border-radius: 8px;
            padding: 12px 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        }

        #chart {
            min-height: 220px;
            height: 40vw;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            padding-top: 6px;
            resize: both;
            overflow: auto;
        }

        #sidebar {
            #controls {
                max-height: 70vh;
                overflow-y: auto;
            }

            width: 280px;
            min-width: 300px;
            max-width: 90vw;
            border-radius: 8px;
            position: relative;
        }

        #sidebar .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
            background: rgba(0, 0, 0, 0.03);
            z-index: 10;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        #sidebar.collapsed {
            display: none !important;
        }

        #chart-wrapper {
            flex: 1 1 0%;
        }

        #chart-wrapper.expanded {
            flex-basis: 100% !important;
        }

        @media (max-width: 600px) {
            .loan-control {
                padding: 8px 2px;
                font-size: 0.97em;
            }

            .input-group-text {
                font-size: 0.97em;
                min-width: 90px !important;
                padding-left: 6px;
                padding-right: 6px;
            }

            .form-control,
            .form-range {
                font-size: 0.97em;
            }

            #chart {
                min-height: 160px;
                height: 45vw;
                max-height: 220px;
            }

            h2 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            #add-loan-btn {
                font-size: 0.97em;
                padding: 6px 18px;
            }
        }
    </style>
</head>

<body>


    <div class="container-fluid">
        <h2 class="mb-1 text-center">Loan Payoff Simulator</h2>
        <p class="text-center mb-1">Visualize how your loan payments affect your balances over time. Add as many loans
            as you like. You can view the code on <a href="https://github.com/EbrahimKaram/Loan-calculator"
                target="_blank" title="GitHub">GitHub<span>üêô</span></a>.</p>

        <div class="text-left mb-2">
            <button id="toggle-controls-btn" class="btn btn-outline-dark btn-sm">Hide Controls</button>
        </div>
        <div class="d-flex flex-column flex-md-row">
            <!-- Sidebar Controls -->

            <div id="sidebar" class="col-12 col-md-4 p-2 bg-white shadow-sm">
                <div class="resize-handle"></div>



                <div id="controls" class="grid w-auto"></div>

                <div class="text-center mt-3 d-flex flex-column gap-2">
                    <button id="add-loan-btn" class="btn btn-primary btn-sm">Add Loan</button>
                    <input type="file" id="import-csv" accept=".csv" style="display:none">
                    <button id="import-csv-btn" class="btn btn-secondary btn-sm">Import CSV</button>
                    <button id="download-template-btn" class="btn btn-outline-secondary btn-sm">Download Template
                        CSV</button>
                </div>
            </div>

            <!-- Chart Area -->
            <div id="chart-wrapper" class="flex-grow-1 p-2">
                <div id="chart"></div>
            </div>
        </div>
    </div>

    <script>
        let loans = [
            { name: "Car Loan", balance: 15000, rate: 0.05, payment: 300 },
            { name: "Student Loan", balance: 40000, rate: 0.045, payment: 500 },
            { name: "Credit Card", balance: 8000, rate: 0.18, payment: 200 }
        ];

        const controlsDiv = document.getElementById('controls');
        const chart = echarts.init(document.getElementById('chart'));
        window.addEventListener('resize', () => chart.resize());
        const chartDiv = document.getElementById('chart');
        let resizeObserver = new ResizeObserver(() => chart.resize());
        resizeObserver.observe(chartDiv);

        // Sidebar toggle
        const toggleBtn = document.getElementById('toggle-controls-btn');
        const sidebar = document.getElementById('sidebar');
        const chartWrapper = document.getElementById('chart-wrapper');
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.textContent = 'Show Controls';
                chartWrapper.classList.add('expanded');
                chartWrapper.classList.remove('collapsed');
            } else {
                toggleBtn.textContent = 'Hide Controls';
                chartWrapper.classList.remove('expanded');
                chartWrapper.classList.add('collapsed');
            }
            setTimeout(() => chart.resize(), 310); // resize after animation
        });


        // Sidebar resize logic
        const sidebarHandle = document.querySelector('#sidebar .resize-handle');
        let isResizing = false;
        let startX, startWidth;
        sidebarHandle.addEventListener('mousedown', function (e) {
            isResizing = true;
            startX = e.clientX;
            startWidth = sidebar.offsetWidth;
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', function (e) {
            if (!isResizing) return;
            let newWidth = Math.max(180, Math.min(window.innerWidth * 0.9, startWidth + (e.clientX - startX)));
            sidebar.style.width = newWidth + 'px';
            sidebar.style.minWidth = newWidth + 'px';
            setTimeout(() => chart.resize(), 0);
        });
        document.addEventListener('mouseup', function () {
            if (isResizing) {
                isResizing = false;
                document.body.style.userSelect = '';
            }
        });

        // Render controls
        function renderControls() {
            controlsDiv.innerHTML = '';
            loans.forEach((loan, idx) => {
                const paymentMax = Math.ceil(loan.balance + loan.balance * loan.rate / 12);
                const col = document.createElement('div');
                col.className = 'col-12 ';
                col.innerHTML = `
<div class="loan-control m-1">
    <div class="mb-2 input-group">
        <span class="input-group-text" style="min-width: 110px;">Loan Name</span>
        <input type="text" class="form-control" value="${loan.name}" data-field="name" data-idx="${idx}">
    </div>
    <div class="mb-2 input-group rounded">
        <span class="input-group-text" style="min-width: 110px;">Balance ($)</span>
        <input type="number" class="form-control" min="0" step="100" value="${loan.balance}" data-field="balanceNumber"
            data-idx="${idx}">
    </div>
    <div class="mb-2 input-group rounded">
        <span class="input-group-text" style="min-width: 170px;">Interest Rate (%)</span>
        <input type="number" class="form-control" min="0" max="25" step="0.1" value="${(loan.rate * 100).toFixed(1)}"
            data-field="rateNumber" data-idx="${idx}">
        <input type="range" class="form-range ms-2" min="0" max="25" step="0.1" value="${(loan.rate * 100).toFixed(1)}"
            data-field="rate" data-idx="${idx}">
    </div>
    <div class="mb-3 input-group rounded">
        <span class="input-group-text" style="min-width: 170px;">Monthly Payment ($)</span>
        <input type="number" class="form-control" min="10" max="${paymentMax}" step="10" value="${loan.payment}"
            data-field="paymentNumber" data-idx="${idx}">
        <input type="range" class="form-range ms-2" min="10" max="${paymentMax}" step="10" value="${loan.payment}"
            data-field="payment" data-idx="${idx}">
    </div>
  <div class="mb-2">
    <strong>Last Payment:</strong> <span class="last-payment-date" data-idx="${idx}">${loan.lastPaymentDate || '‚Äî'}</span>
</div>
    <button class="btn btn-danger w-100" data-remove="${idx}">Remove</button>
</div>
`;
                controlsDiv.appendChild(col);
            });
        }

        // CSV Import
        document.getElementById('import-csv-btn').addEventListener('click', () => {
            document.getElementById('import-csv').click();
        });
        document.getElementById('import-csv').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                const text = evt.target.result;
                const parseCSVLine = (line) => {
                    const values = [];
                    let current = '', insideQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && (i === 0 || line[i - 1] !== '\\')) {
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            values.push(current.trim()); current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());
                    return values;
                };
                const lines = text.split(/\r?\n/).filter(l => l.trim());
                if (lines.length < 2) return;
                const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
                const nameIdx = headers.indexOf('name');
                const balanceIdx = headers.indexOf('balance');
                const rateIdx = headers.indexOf('rate');
                const paymentIdx = headers.indexOf('payment');
                if (nameIdx === -1 || balanceIdx === -1 || rateIdx === -1 || paymentIdx === -1) {
                    alert('CSV must have headers: name,balance,rate,payment'); return;
                }
                const cleanNumber = (str) => parseFloat(str.replace(/[\$, %]/g, '').replace(/,/g, '')) || 0;
                const imported = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVLine(lines[i]);
                    if (row.length < 4) continue;
                    imported.push({
                        name: row[nameIdx].replace(/^"|"$/g, '').trim(),
                        balance: cleanNumber(row[balanceIdx]),
                        rate: cleanNumber(row[rateIdx]) / 100,
                        payment: cleanNumber(row[paymentIdx])
                    });
                }
                if (imported.length) {
                    loans = imported;
                    renderControls();
                    updateChart();
                } else {
                    alert('No valid loans found in CSV.');
                }
            };
            reader.readAsText(file);
        });

        ///// update last payment date
        function updateLastPaymentDates() {
            loans.forEach((loan, idx) => {
                const el = document.querySelector(`.last-payment-date[data-idx="${idx}"]`);
                if (el) el.textContent = loan.lastPaymentDate || '‚Äî';
            });
        }

        // Download template
        document.getElementById('download-template-btn').addEventListener('click', () => {
            const csv = 'name,balance,rate,payment\nCar Loan,15000,5,300\nStudent Loan,40000,4.5,500\nCredit Card,8000,18,200\n';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'loan_template.csv';
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Input handling
        controlsDiv.addEventListener('input', e => {
            const field = e.target.dataset.field;
            const idx = e.target.dataset.idx;
            if (idx === undefined) return;
            const syncValue = val => parseFloat(val) || 0;
            if (field === 'rate' || field === 'rateNumber') {
                const val = syncValue(e.target.value);
                loans[idx].rate = val / 100;
                controlsDiv.querySelector(`input[data-field="${field === 'rate' ? 'rateNumber' : 'rate'}"][data-idx="${idx}"]`).value = val;
                adjustPaymentMax(idx);
            } else if (field === 'payment' || field === 'paymentNumber') {
                const val = Math.max(syncValue(e.target.value), 0);
                loans[idx].payment = val;
                controlsDiv.querySelector(`input[data-field="${field === 'payment' ? 'paymentNumber' : 'payment'}"][data-idx="${idx}"]`).value = val;
            } else if (field === 'balance' || field === 'balanceNumber') {
                const val = Math.max(syncValue(e.target.value), 0);
                loans[idx].balance = val;
                controlsDiv.querySelector(`input[data-field="${field === 'balance' ? 'balanceNumber' : 'balance'}"][data-idx="${idx}"]`).value = val;
                adjustPaymentMax(idx);
            } else if (field === 'name') {
                loans[idx].name = e.target.value;
            }
            updateChart();
        });
        function adjustPaymentMax(idx) {
            const slider = controlsDiv.querySelector(`input[data-field="payment"][data-idx="${idx}"]`);
            const numberInput = controlsDiv.querySelector(`input[data-field="paymentNumber"][data-idx="${idx}"]`);
            if (slider && numberInput) {
                const maxVal = Math.ceil(loans[idx].balance + loans[idx].balance * loans[idx].rate / 12);
                slider.max = maxVal;
                numberInput.max = maxVal;
                if (loans[idx].payment > maxVal) {
                    loans[idx].payment = maxVal;
                    slider.value = maxVal;
                    numberInput.value = maxVal;
                }
            }
        }
        controlsDiv.addEventListener('click', e => {
            if (e.target.dataset.remove !== undefined) {
                loans.splice(parseInt(e.target.dataset.remove, 10), 1);
                chart.clear();
                renderControls();
                updateChart();
            }
        });
        document.getElementById('add-loan-btn').addEventListener('click', () => {
            loans.push({ name: `Loan ${loans.length + 1}`, balance: 10000, rate: 0.05, payment: 200 });
            renderControls();
            updateChart();
        });

        // Loan calculate Balances
        function calculateBalances(loans) {
            let allBalances = loans.map(l => [l.balance]);
            let months = 0, maxMonths = 0;
            let payoffMonths = Array(loans.length).fill(null); // store month of last payment

            while (true) {
                let allPaid = true;
                months++;
                for (let i = 0; i < loans.length; i++) {
                    let bal = allBalances[i][months - 1];
                    if (bal > 0) {
                        allPaid = false;
                        let interest = bal * (loans[i].rate / 12);
                        let newBal = bal + interest - loans[i].payment;
                        if (newBal <= 0 && payoffMonths[i] === null) {
                            payoffMonths[i] = months; // record payoff month
                        }
                        allBalances[i][months] = Math.max(newBal, 0);
                    } else {
                        allBalances[i][months] = 0;
                    }
                }
                if (allPaid || months > 600) break;
                maxMonths = months;
            }

            // Calculate payoff dates
            let now = new Date();
            loans.forEach((loan, i) => {
                if (payoffMonths[i] !== null) {
                    let totalMonths = now.getMonth() + payoffMonths[i];
                    let year = now.getFullYear() + Math.floor(totalMonths / 12);
                    let month = (totalMonths % 12) + 1;
                    loan.lastPaymentDate = new Date(year, month - 1, 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                } else {
                    loan.lastPaymentDate = '‚Äî';
                }
            });

            return { months: Array.from({ length: maxMonths + 1 }, (_, i) => i), balances: allBalances };
        }


        // Chart update
        function updateChart() {
            let { months, balances } = calculateBalances(loans);

            updateLastPaymentDates();

            chart.setOption({
                animationDurationUpdate: 500,       // half a second
                animationEasingUpdate: 'cubicOut', // smooth easing
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } },
                    valueFormatter: v => parseFloat(v).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                    formatter: function (params) {
                        let axisVal = params[0].axisValue;
                        let match = axisVal.match(/Month (\d+)/);
                        let monthNum = match ? parseInt(match[1], 10) : 0;
                        let now = new Date();
                        let totalMonths = now.getMonth() + monthNum;
                        let year = now.getFullYear() + Math.floor(totalMonths / 12);
                        let month = (totalMonths % 12) + 1;
                        let monthName = new Date(year, month - 1, 1).toLocaleString('default', { month: 'short' });
                        let s = axisVal + ` (${monthName} ${year})<br/>`;
                        params.slice().reverse().forEach(function (item) {
                            s += '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:' + item.color + '"></span>';
                            s += item.seriesName + ': $' + parseFloat(item.data).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '<br/>';
                        });
                        return s;
                    }
                },
                legend: { data: loans.map(l => l.name) },
                toolbox: { feature: { saveAsImage: {} } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: [{ type: 'category', boundaryGap: false, data: months.map(m => `Month ${m}`) }],
                yAxis: [{ type: 'value', name: 'Balance ($)' }],
                series: loans.map((loan, idx) => ({
                    name: loan.name,
                    type: 'line',
                    stack: 'Total',
                    smooth: true,
                    lineStyle: { width: 0 },
                    showSymbol: false,
                    lineStyle: { width: 2, color: getGradientColor(idx, true) }, // match top gradient
                    itemStyle: { color: getGradientColor(idx, true) },           // legend color
                    areaStyle: {
                        opacity: 0.8,
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: getGradientColor(idx, true) },
                            { offset: 1, color: getGradientColor(idx, false) }
                        ])
                    },
                    emphasis: { focus: 'series' },
                    data: balances[idx]
                }))
            });
        }

        function getGradientColor(i, top) {
            const palette = [
                ['#ff7f50', '#ffdab9'], // coral ‚Üí peachpuff
                ['#87cefa', '#e0ffff'], // light sky blue ‚Üí light cyan
                ['#da70d6', '#dda0dd'], // orchid ‚Üí plum
                ['#32cd32', '#98fb98'], // lime green ‚Üí pale green
                ['#ffd700', '#fffacd'], // gold ‚Üí lemon chiffon
                ['#ff69b4', '#ffc0cb'], // hot pink ‚Üí pink
                ['#40e0d0', '#afeeee'], // turquoise ‚Üí pale turquoise
                ['#ba55d3', '#d8bfd8'], // medium orchid ‚Üí thistle
                ['#ff8c00', '#ffdead'], // dark orange ‚Üí navajo white
                ['#228b22', '#90ee90'], // forest green ‚Üí light green
                ['#1e90ff', '#add8e6'], // dodger blue ‚Üí light blue
                ['#8b0000', '#f08080'], // dark red ‚Üí light coral
                ['#9932cc', '#e6e6fa'], // dark orchid ‚Üí lavender
                ['#2e8b57', '#98fb98'], // sea green ‚Üí pale green
                ['#ff1493', '#ffb6c1']  // deep pink ‚Üí light pink
            ];
            return palette[i % palette.length][top ? 0 : 1];
        }

        // Initial render
        renderControls();
        updateChart();
    </script>
    <!-- Buy Me a Coffee Floating Button -->
    <div class="bmc-float">
        <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
            data-name="bmc-button" data-slug="bobKaram" data-color="#5F7FFF" data-emoji="üç∫" data-font="Comic"
            data-text="Cheers to your Goals" data-outline-color="#000000" data-font-color="#ffffff"
            data-coffee-color="#FFDD00"></script>
    </div>
</body>

</html>