<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loan Payoff Chart</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  body {
    background: #f7f8fa;
    padding: 20px;
  }
  .loan-control {
    background: #fff;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }
  .value-display {
    min-width: 50px;
    text-align: right;
    font-weight: 500;
    color: #333;
  }
  #chart {
    height: 500px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    padding-top: 10px;
  }
</style>
</head>
<body>

<div class="container">
  <h2 class="mb-4 text-center">Loan Payoff Simulator</h2>
  
  <div id="controls" class="row"></div>
  
  <div class="d-grid mb-4">
    <button id="add-loan-btn" class="btn btn-primary btn-lg">Add Loan</button>
  </div>
  
  <div id="chart"></div>
</div>

<script>
let loans = [
  { name: "Car Loan", balance: 15000, rate: 0.05, payment: 300 },
  { name: "Student Loan", balance: 40000, rate: 0.045, payment: 500 },
  { name: "Credit Card", balance: 8000, rate: 0.18, payment: 200 }
];

const controlsDiv = document.getElementById('controls');
const chart = echarts.init(document.getElementById('chart'));

// ===== UI Rendering =====
function renderControls() {
  controlsDiv.innerHTML = '';
  loans.forEach((loan, idx) => {
    const paymentMax = Math.ceil(loan.balance + loan.balance * loan.rate / 12);

    const col = document.createElement('div');
    col.className = 'col-12 col-lg-6';
    col.innerHTML = `
      <div class="loan-control">
        <div class="mb-2">
          <label class="form-label">Loan Name</label>
          <input type="text" class="form-control" value="${loan.name}" data-field="name" data-idx="${idx}">
        </div>

        <div class="mb-2">
          <label class="form-label">Balance ($)</label>
          <input type="number" class="form-control" min="0" step="100" value="${loan.balance}" data-field="balance" data-idx="${idx}">
        </div>

        <div class="mb-2">
          <label class="form-label">Interest Rate: <span id="rate-display-${idx}" class="value-display">${(loan.rate * 100).toFixed(1)}%</span></label>
          <input type="range" class="form-range" min="0" max="25" step="0.1" value="${(loan.rate * 100).toFixed(1)}" data-field="rate" data-idx="${idx}">
        </div>

        <div class="mb-3">
          <label class="form-label">Monthly Payment: <span id="payment-display-${idx}" class="value-display">$${loan.payment}</span></label>
          <input type="range" class="form-range" min="10" max="${paymentMax}" step="10" value="${loan.payment}" data-field="payment" data-idx="${idx}">
        </div>

        <button class="btn btn-danger w-100" data-remove="${idx}">Remove</button>
      </div>
    `;
    controlsDiv.appendChild(col);
  });
}

// ===== Event Delegation =====
controlsDiv.addEventListener('input', e => {
  const field = e.target.dataset.field;
  const idx = e.target.dataset.idx;
  if (field && idx !== undefined) {
    if (field === 'rate') {
      loans[idx].rate = (parseFloat(e.target.value) || 0) / 100;
      document.getElementById(`rate-display-${idx}`).textContent = `${parseFloat(e.target.value).toFixed(1)}%`;
      // Adjust payment max when rate changes
      adjustPaymentMax(idx);
    } else if (field === 'payment') {
      loans[idx].payment = Math.max(parseFloat(e.target.value) || 0, 0);
      document.getElementById(`payment-display-${idx}`).textContent = `$${parseFloat(e.target.value)}`;
    } else if (field === 'balance') {
      loans[idx].balance = Math.max(parseFloat(e.target.value) || 0, 0);
      // Adjust payment max when balance changes
      adjustPaymentMax(idx);
    } else {
      loans[idx][field] = e.target.value;
    }
    updateChart();
  }
});

function adjustPaymentMax(idx) {
  const slider = controlsDiv.querySelector(`input[data-field="payment"][data-idx="${idx}"]`);
  if (slider) {
    const maxVal = Math.ceil(loans[idx].balance + loans[idx].balance * loans[idx].rate / 12);
    slider.max = maxVal;
    if (loans[idx].payment > maxVal) {
      loans[idx].payment = maxVal;
      slider.value = maxVal;
      document.getElementById(`payment-display-${idx}`).textContent = `$${maxVal}`;
    }
  }
}

controlsDiv.addEventListener('click', e => {
  if (e.target.dataset.remove !== undefined) {
    loans.splice(parseInt(e.target.dataset.remove, 10), 1);
    renderControls();
    updateChart();
  }
});

document.getElementById('add-loan-btn').addEventListener('click', () => {
  loans.push({ name: `Loan ${loans.length + 1}`, balance: 10000, rate: 0.05, payment: 200 });
  renderControls();
  updateChart();
});

// ===== Loan Calculation =====
function calculateBalances(loans) {
  let allBalances = loans.map(l => [l.balance]);
  let months = 0;
  let maxMonths = 0;

  while (true) {
    let allPaid = true;
    months++;
    for (let i = 0; i < loans.length; i++) {
      let bal = allBalances[i][months - 1];
      if (bal > 0) {
        allPaid = false;
        let interest = bal * (loans[i].rate / 12);
        let newBal = bal + interest - loans[i].payment;
        allBalances[i][months] = Math.max(newBal, 0);
      } else {
        allBalances[i][months] = 0;
      }
    }
    if (allPaid || months > 600) break;
    maxMonths = months;
  }
  return { months: Array.from({ length: maxMonths + 1 }, (_, i) => i), balances: allBalances };
}

// ===== Chart Update =====
function updateChart() {
  let { months, balances } = calculateBalances(loans);
  chart.setOption({
    tooltip: { trigger: 'axis' },
    legend: { data: loans.map(l => l.name) },
    toolbox: { feature: { saveAsImage: {} } },
    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
    xAxis: [{ type: 'category', boundaryGap: false, data: months.map(m => `Month ${m}`) }],
    yAxis: [{ type: 'value', name: 'Balance ($)' }],
    series: loans.map((loan, idx) => ({
      name: loan.name,
      type: 'line',
      stack: 'Total',
      smooth: true,
      lineStyle: { width: 0 },
      showSymbol: false,
      areaStyle: {
        opacity: 0.8,
        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
          { offset: 0, color: getGradientColor(idx, true) },
          { offset: 1, color: getGradientColor(idx, false) }
        ])
      },
      emphasis: { focus: 'series' },
      data: balances[idx]
    }))
  });
}

// ===== Gradient Colors =====
function getGradientColor(i, top) {
  const palette = [
    ['#ff7f50', '#ffdab9'],
    ['#87cefa', '#e0ffff'],
    ['#da70d6', '#dda0dd'],
    ['#32cd32', '#98fb98'],
    ['#ffd700', '#fffacd']
  ];
  return palette[i % palette.length][top ? 0 : 1];
}

// Initial render
renderControls();
updateChart();
</script>

</body>
</html>
