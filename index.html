<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Loan Payoff Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body {
            background: #f7f8fa;
            padding: 20px;
        }

        .loan-control {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        }

        #chart {
            min-height: 500px;
            height: 100%;
            width: 100%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            padding-top: 10px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2 class="mb-4 text-center">Loan Payoff Simulator</h2>

        <div id="controls" class="row"></div>

        <div class="text-center mb-4">
            <button id="add-loan-btn" class="btn btn-primary btn-lg">Add Loan</button>
        </div>

        <div id="chart"></div>
    </div>

    <script>
        let loans = [
            { name: "Car Loan", balance: 15000, rate: 0.05, payment: 300 },
            { name: "Student Loan", balance: 40000, rate: 0.045, payment: 500 },
            { name: "Credit Card", balance: 8000, rate: 0.18, payment: 200 }
        ];

        const controlsDiv = document.getElementById('controls');
        const chart = echarts.init(document.getElementById('chart'));
        window.addEventListener('resize', () => {
            chart.resize();
        });

        // ===== UI Rendering =====
        function renderControls() {
            controlsDiv.innerHTML = '';
            loans.forEach((loan, idx) => {
                const paymentMax = Math.ceil(loan.balance + loan.balance * loan.rate / 12);

                const col = document.createElement('div');
                col.className = 'col-12 col-lg-4';
                col.innerHTML = `
      <div class="loan-control">
        <!-- Loan Name -->
        <div class="mb-2 input-group">
          <span class="input-group-text" style="min-width: 110px;">Loan Name</span>
          <input type="text" class="form-control" value="${loan.name}" data-field="name" data-idx="${idx}">
        </div>

        <!-- Balance -->
        <div class="mb-2 input-group">
          <span class="input-group-text" style="min-width: 110px;">Balance ($)</span>
          <input type="number" class="form-control" min="0" step="100" 
                 value="${loan.balance}" data-field="balanceNumber" data-idx="${idx}">
        </div>

   <!-- Interest Rate -->
   <div class="mb-2 input-group">
     <span class="input-group-text" style="min-width: 170px;">Interest Rate (%)</span>
     <input type="number" class="form-control" min="0" max="25" step="0.1"
       value="${(loan.rate * 100).toFixed(1)}" data-field="rateNumber" data-idx="${idx}">
     <input type="range" class="form-range ms-2" min="0" max="25" step="0.1"
       value="${(loan.rate * 100).toFixed(1)}" data-field="rate" data-idx="${idx}">
   </div>

   <!-- Monthly Payment -->
   <div class="mb-3 input-group">
     <span class="input-group-text" style="min-width: 170px;">Monthly Payment ($)</span>
     <input type="number" class="form-control" min="10" max="${paymentMax}" step="10"
       value="${loan.payment}" data-field="paymentNumber" data-idx="${idx}">
     <input type="range" class="form-range ms-2" min="10" max="${paymentMax}" step="10"
       value="${loan.payment}" data-field="payment" data-idx="${idx}">
   </div>

        <!-- Remove Loan -->
        <button class="btn btn-danger w-100" data-remove="${idx}">Remove</button>
      </div>
    `;
                controlsDiv.appendChild(col);
            });
        }

        // ===== Event Delegation =====
        controlsDiv.addEventListener('input', e => {
            const field = e.target.dataset.field;
            const idx = e.target.dataset.idx;
            if (idx === undefined) return;

            const syncValue = val => parseFloat(val) || 0;

            // Sync number <-> slider for each type
            if (field === 'rate' || field === 'rateNumber') {
                const val = syncValue(e.target.value);
                loans[idx].rate = val / 100;
                if (field === 'rate') {
                    controlsDiv.querySelector(`input[data-field="rateNumber"][data-idx="${idx}"]`).value = val;
                } else {
                    controlsDiv.querySelector(`input[data-field="rate"][data-idx="${idx}"]`).value = val;
                }
                adjustPaymentMax(idx);

            } else if (field === 'payment' || field === 'paymentNumber') {
                const val = Math.max(syncValue(e.target.value), 0);
                loans[idx].payment = val;
                if (field === 'payment') {
                    controlsDiv.querySelector(`input[data-field="paymentNumber"][data-idx="${idx}"]`).value = val;
                } else {
                    controlsDiv.querySelector(`input[data-field="payment"][data-idx="${idx}"]`).value = val;
                }

            } else if (field === 'balance' || field === 'balanceNumber') {
                const val = Math.max(syncValue(e.target.value), 0);
                loans[idx].balance = val;
                if (field === 'balance') {
                    controlsDiv.querySelector(`input[data-field="balanceNumber"][data-idx="${idx}"]`).value = val;
                } else {
                    controlsDiv.querySelector(`input[data-field="balance"][data-idx="${idx}"]`).value = val;
                }
                adjustPaymentMax(idx);

            } else if (field === 'name') {
                loans[idx].name = e.target.value;
            }

            updateChart();
        });

        function adjustPaymentMax(idx) {
            const slider = controlsDiv.querySelector(`input[data-field="payment"][data-idx="${idx}"]`);
            const numberInput = controlsDiv.querySelector(`input[data-field="paymentNumber"][data-idx="${idx}"]`);
            if (slider && numberInput) {
                const maxVal = Math.ceil(loans[idx].balance + loans[idx].balance * loans[idx].rate / 12);
                slider.max = maxVal;
                numberInput.max = maxVal;
                if (loans[idx].payment > maxVal) {
                    loans[idx].payment = maxVal;
                    slider.value = maxVal;
                    numberInput.value = maxVal;
                }
            }
        }

        controlsDiv.addEventListener('click', e => {
            if (e.target.dataset.remove !== undefined) {
                loans.splice(parseInt(e.target.dataset.remove, 10), 1);
                renderControls();
                updateChart();
            }
        });

        document.getElementById('add-loan-btn').addEventListener('click', () => {
            loans.push({ name: `Loan ${loans.length + 1}`, balance: 10000, rate: 0.05, payment: 200 });
            renderControls();
            updateChart();
        });

        // ===== Loan Calculation =====
        function calculateBalances(loans) {
            let allBalances = loans.map(l => [l.balance]);
            let months = 0;
            let maxMonths = 0;

            while (true) {
                let allPaid = true;
                months++;
                for (let i = 0; i < loans.length; i++) {
                    let bal = allBalances[i][months - 1];
                    if (bal > 0) {
                        allPaid = false;
                        let interest = bal * (loans[i].rate / 12);
                        let newBal = bal + interest - loans[i].payment;
                        allBalances[i][months] = Math.max(newBal, 0);
                    } else {
                        allBalances[i][months] = 0;
                    }
                }
                if (allPaid || months > 600) break;
                maxMonths = months;
            }
            return { months: Array.from({ length: maxMonths + 1 }, (_, i) => i), balances: allBalances };
        }

        // ===== Chart Update =====
        function updateChart() {
            let { months, balances } = calculateBalances(loans);
            chart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    }
                },
                legend: { data: loans.map(l => l.name) },
                toolbox: { feature: { saveAsImage: {} } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: [{ type: 'category', boundaryGap: false, data: months.map(m => `Month ${m}`) }],
                yAxis: [{ type: 'value', name: 'Balance ($)' }],
                series: loans.map((loan, idx) => ({
                    name: loan.name,
                    type: 'line',
                    stack: 'Total',
                    smooth: true,
                    lineStyle: { width: 0 },
                    showSymbol: false,
                    areaStyle: {
                        opacity: 0.8,
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: getGradientColor(idx, true) },
                            { offset: 1, color: getGradientColor(idx, false) }
                        ])
                    },
                    emphasis: { focus: 'series' },
                    data: balances[idx]
                }))
            });
        }

        // ===== Gradient Colors =====
        function getGradientColor(i, top) {
            const palette = [
                ['#ff7f50', '#ffdab9'],
                ['#87cefa', '#e0ffff'],
                ['#da70d6', '#dda0dd'],
                ['#32cd32', '#98fb98'],
                ['#ffd700', '#fffacd']
            ];
            return palette[i % palette.length][top ? 0 : 1];
        }

        // Initial render
        renderControls();
        updateChart();
    </script>

</body>

</html>